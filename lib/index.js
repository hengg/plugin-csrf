"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TransType=void 0;const crypto=require("crypto"),Tokens=require("csrf");var TransType;!function(e){e[e.header=0]="header",e[e.cookie=1]="cookie",e[e.body=2]="body"}(TransType=exports.TransType||(exports.TransType={}));const aesEncrypt=(e,t)=>{const r=crypto.createCipher("aes192",t);e=r.update(e,"utf8","hex");return e+=r.final("hex")},aesDecrypt=(e,t)=>{const r=crypto.createDecipher("aes192",t);e=r.update(e,"hex","utf8");return e+=r.final("utf8")};exports.default=(e,t={})=>{let o=new Tokens;const{tokenKey:a,secretKey:n,ctxTokenKey:c,maxAge:y,excludes:p,transType:d,withUid:i,uidKey:T}=Object.assign({excludes:["GET","HEAD","OPTIONS"],tokenKey:"uma_token",secretKey:"uma_token_key",ctxTokenKey:"csrfToken",maxAge:2592e6,transType:TransType.header,withUid:!1,uidKey:"uid"},t);return async(t,e)=>{if(!p.includes(t.method)){var r=t.cookies.get(n);let e;switch(d){case TransType.header:e=t.headers&&t.headers[a];break;case TransType.body:e=t.request.body&&t.request.body[a];break;case TransType.cookie:e=t.cookies.get(a);break;default:e=t.headers&&t.headers[a]}console.log({transType:d,token:e,tokenKey:a,secret:r,cookies:t.cookies.get("i18n")}),e&&r||t.throw(403,"CSRF Token Not Found!"),i&&t[T]&&(e=aesDecrypt(e,t[T])),o.verify(r,e)||t.throw(403,"CSRF Token Invalid!")}r=o.secretSync();let s;s=i&&t[T]?aesEncrypt(o.create(r),t[T]):o.create(r),t[c]=s,t.append(a,s),t.append("Access-Control-Expose-Headers",a),t.cookies.set(n,r,{maxAge:y,httpOnly:!0}),t.cookies.set(a,s,{maxAge:y,httpOnly:!1}),await e()}};